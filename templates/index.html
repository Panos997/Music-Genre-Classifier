<!DOCTYPE html>
<html>
<head>
    <title>AI Music Genre Predictor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 50px; background: #f4f4f9; }
        .container { background: white; padding: 30px; border-radius: 15px; display: inline-block; box-shadow: 0 8px 16px rgba(0,0,0,0.1); width: 450px; }
        
        /* Progress Bar Styling */
        #progressContainer { width: 100%; background-color: #ddd; border-radius: 10px; margin: 20px 0; display: none; }
        #progressBar { width: 0%; height: 20px; background-color: #1db954; border-radius: 10px; text-align: center; line-height: 20px; color: white; font-size: 12px; transition: width 0.3s; }
        
        .result { margin-top: 20px; font-weight: bold; }
        canvas { margin-top: 20px; max-width: 100%; }
        button { background: #1db954; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-size: 16px; font-weight: bold; }
        input { margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ Music Genre AI</h1>
        <p>Î‘Î½Î­Î²Î±ÏƒÎµ Î­Î½Î± MP3 Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ·</p>
        
        <input type="file" id="audioFile" accept="audio/*">
        <br>
        <button onclick="uploadFile()">Î ÏÏŒÎ²Î»ÎµÏˆÎ·!</button>

        <div id="progressContainer">
            <div id="progressBar">0%</div>
        </div>

        <div id="loading" style="display:none; margin-top: 10px;">â³ Î‘Î½Î±Î»ÏÏ‰ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿...</div>
        
        <div class="result" id="results"></div>
        
        <canvas id="genreChart"></canvas>
    </div>

    <script>
    let myChart = null;

    async function uploadFile() {
        const fileInput = document.getElementById('audioFile');
        const resultsDiv = document.getElementById('results');
        const progContainer = document.getElementById('progressContainer');
        const progBar = document.getElementById('progressBar');
        
        if (!fileInput.files[0]) return alert("Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿!");

        progContainer.style.display = "block";
        progBar.style.width = "0%";
        progBar.style.backgroundColor = "#1db954";
        progBar.innerHTML = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î®Ï‡Î¿Ï…...";

        try {
            // 1. "ÎšÎŸÎ¨Î™ÎœÎŸ" Î¤ÎŸÎ¥ Î—Î§ÎŸÎ¥ (Compression/Trimming)
            const originalFile = fileInput.files[0];
            const trimmedBlob = await trimAudio(originalFile, 30); // ÎšÏŒÎ²Î¿Ï…Î¼Îµ ÏƒÏ„Î± 30 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
            
            const formData = new FormData();
            formData.append('file', trimmedBlob, "trimmed_audio.mp3");

            // 2. Î Î¡Î‘Î“ÎœÎ‘Î¤Î™ÎšÎŸ UPLOAD ÎœÎ• PROGRESS BAR
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener("progress", (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progBar.style.width = percentComplete + "%";
                    progBar.innerHTML = "Upload: " + percentComplete + "%";
                }
            });

            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        progBar.style.width = "100%";
                        progBar.style.backgroundColor = "#1db954";
                        progBar.innerHTML = "Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ!";
                        const data = JSON.parse(xhr.responseText);
                        renderChart(data); // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î Î¯Ï„Î±Ï‚
                        showTextResults(data); // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎšÎµÎ¹Î¼Î­Î½Î¿Ï… (Î³Î¹Î± Î½Î± ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹)
                    } else {
                        progBar.style.backgroundColor = "red";
                        progBar.innerHTML = "Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î¿Î½ Server";
                    }
                }
            };

            // Î¦Î¬ÏƒÎ· Î‘Î½Î¬Î»Ï…ÏƒÎ·Ï‚ (Processing)
            xhr.upload.onload = () => {
                progBar.style.backgroundColor = "#ffa500";
                progBar.innerHTML = "Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î¿ Î´ÎµÎ¯Î³Î¼Î±...";
            };

            xhr.open("POST", "/predict", true);
            xhr.send(formData);

        } catch (error) {
            console.error(error);
            alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï….");
        }
    }

    // Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î— Î“Î™Î‘ Î¤ÎŸ ÎšÎŸÎ¨Î™ÎœÎŸ Î¤ÎŸÎ¥ Î—Î§ÎŸÎ¥
    async function trimAudio(file, seconds) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        
        // Î¥Ï€Î¿Î»Î¿Î³Î¯Î¶Î¿Ï…Î¼Îµ Ï„Î± frames Î³Î¹Î± Ï„Î± Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± Ï€Î¿Ï… Î¸Î­Î»Î¿Ï…Î¼Îµ
        const lengthToKeep = Math.min(audioBuffer.sampleRate * seconds, audioBuffer.length);
        const newBuffer = audioCtx.createBuffer(audioBuffer.numberOfChannels, lengthToKeep, audioBuffer.sampleRate);
        
        for (let i = 0; i < audioBuffer.numberOfChannels; i++) {
            newBuffer.copyToChannel(audioBuffer.getChannelData(i).slice(0, lengthToKeep), i);
        }
        
        // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÏƒÎµ Blob (WAV format Î³Î¹Î± Ï„Î±Ï‡ÏÏ„Î·Ï„Î±)
        return new Promise(resolve => {
            const worker = new Worker(URL.createObjectURL(new Blob([`
                self.onmessage = function(e) {
                    const buffer = e.data;
                    const view = new DataView(new ArrayBuffer(44 + buffer[0].length * 2));
                    // WAV Headers
                    writeString(view, 0, 'RIFF');
                    view.setUint32(4, 32 + buffer[0].length * 2, true);
                    writeString(view, 8, 'WAVE');
                    writeString(view, 12, 'fmt ');
                    view.setUint32(16, 16, true);
                    view.setUint16(20, 1, true);
                    view.setUint16(22, buffer.length, true);
                    view.setUint32(24, 44100, true);
                    view.setUint32(28, 44100 * 2, true);
                    view.setUint16(32, 2, true);
                    view.setUint16(34, 16, true);
                    writeString(view, 36, 'data');
                    view.setUint32(40, buffer[0].length * 2, true);
                    // PCM Data
                    let offset = 44;
                    for (let i = 0; i < buffer[0].length; i++) {
                        for (let channel = 0; channel < buffer.length; channel++) {
                            let s = Math.max(-1, Math.min(1, buffer[channel][i]));
                            view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                            offset += 2;
                        }
                    }
                    self.postMessage(new Blob([view], {type: 'audio/wav'}));
                };
                function writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
                }
            `], {type: 'text/javascript'})));
            
            const channels = [];
            for(let i=0; i<newBuffer.numberOfChannels; i++) channels.append(newBuffer.getChannelData(i));
            worker.postMessage(channels);
            worker.onmessage = (e) => resolve(e.data);
        });
    }

    function showTextResults(data) {
        const resultsDiv = document.getElementById('results');
        let html = "<h3>Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±:</h3>";
        data.forEach(item => {
            html += `<p>${item.genre}: ${item.probability}%</p>`;
        });
        resultsDiv.innerHTML = html;
    }

    function renderChart(data) {
        const ctx = document.getElementById('genreChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(i => i.genre),
                datasets: [{
                    data: data.map(i => i.probability),
                    backgroundColor: ['#1db954', '#1ed760', '#81b71a']
                }]
            },
            options: { 
                responsive: true,
                plugins: { tooltip: { enabled: true } }
            }
        });
    }
</script>
</body>
</html>
